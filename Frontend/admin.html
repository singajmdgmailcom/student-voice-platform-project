<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Student Voice</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .navbar-brand { font-weight: bold; }
        .feedback-item { background-color: #ffffff; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .status-badge { font-size: 0.8em; padding: 5px 8px; border-radius: 5px; }
        .badge-pending { background-color: #ffc107; color: #343a40; }
        .badge-resolved { background-color: #28a745; color: #ffffff; }
        .badge-rejected { background-color: #dc3545; color: #ffffff; }
        .action-buttons button { margin-right: 5px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Admin Panel</a>
            <div class="d-flex ms-auto">
                <a href="/" class="btn btn-info">User Panel</a>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h2 class="mb-4 text-center">Manage Student Feedback</h2>
        <div id="feedbackList">
            <p class="text-center text-muted">Loading feedback...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        // Firebase configuration will be dynamically injected by the server here
        const firebaseConfig = {}; // Placeholder: The server will replace this line

        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Authentication imports removed as there's no login
        // import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";


        const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
        const db = getFirestore(app);
        // const auth = getAuth(app); // Auth instance not needed if no login


        // Admin login functions and onAuthStateChanged removed
        // async function adminLogin() { ... }
        // onAuthStateChanged(auth, (user) => { ... });

        // Load feedback immediately as there's no login required
        loadFeedback();

        async function loadFeedback() {
            const feedbackListDiv = document.getElementById('feedbackList');
            feedbackListDiv.innerHTML = '<p class="text-center text-muted">Loading feedback...</p>'; // Clear and show loading

            // Listen for real-time updates on all feedback
            onSnapshot(collection(db, "feedback"), (snapshot) => {
                if (snapshot.empty) {
                    feedbackListDiv.innerHTML = '<p class="text-center text-muted">No feedback submitted yet.</p>';
                    return;
                }

                feedbackListDiv.innerHTML = ''; // Clear previous feedback
                snapshot.forEach((doc) => {
                    const feedback = doc.data();
                    const badgeClass = {
                        "Pending": "badge-warning",
                        "Resolved": "badge-success",
                        "Rejected": "badge-danger"
                    }[feedback.status] || "badge-secondary";

                    feedbackListDiv.innerHTML += `
                        <div class="feedback-item" data-id="${doc.id}">
                            <h5>${feedback.title} <span class="badge ${badgeClass} float-end">${feedback.status}</span></h5>
                            <p><strong>Category:</strong> ${feedback.category}</p>
                            <p>${feedback.description}</p>
                            <small class="text-muted">Submitted by: ${feedback.submittedBy} on: ${feedback.timestamp.toDate().toLocaleString()}</small>
                            <div class="action-buttons mt-2">
                                <button class="btn btn-sm btn-success" onclick="updateFeedbackStatus('${doc.id}', 'Resolved')">Resolve</button>
                                <button class="btn btn-sm btn-danger" onclick="updateFeedbackStatus('${doc.id}', 'Rejected')">Reject</button>
                            </div>
                        </div>
                    `;
                });
            }, (error) => {
                console.error("Error loading feedback:", error);
                feedbackListDiv.innerHTML = '<p class="text-center text-danger">Error loading feedback.</p>';
            });
        }

        async function updateFeedbackStatus(docId, newStatus) {
            // No authentication check here, relies entirely on Firebase Security Rules
            try {
                const feedbackRef = doc(db, "feedback", docId);
                await updateDoc(feedbackRef, {
                    status: newStatus
                });
                console.log(`Feedback ${docId} status updated to ${newStatus}`);
            } catch (error) {
                console.error("Error updating feedback status:", error);
                alert(`Error updating status: ${error.message}`);
            }
        }

        // Logout function removed as there's no login
        // function logout() { ... }
    </script>
</body>
</html>